// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  REFEREE
  ADMIN
  SUPER_ADMIN
}

enum CategoryType {
  LOTG       // Laws of the Game
  CHALLENGE  // Referees practice
  VAR        // VAR practice
  AR         // A.R. practice
  LIBRARY    // Library content
}

enum QuestionType {
  LOTG_TEXT
  VIDEO_CHALLENGE
  VAR_CLIP
  AR_CLIP
}

enum AssignmentStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model User {
  id                   String               @id @default(cuid())
  email                String               @unique
  name                 String?
  password             String?              // hashed, nullable for social logins
  role                 Role                 @default(REFEREE)
  country              String?
  level                String?              // referee category/level
  image                String?
  emailVerified        DateTime?
  accounts             Account[]
  testSessions         TestSession[]
  testCompletions      UserTestCompletion[]
  mandatoryTestsCreated MandatoryTest[]
  trainingAssignments  TrainingAssignment[]
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Category {
  id               String            @id @default(cuid())
  name             String            @unique
  slug             String            @unique
  type             CategoryType
  description      String?
  order            Int               @default(0)
  videoClips       VideoClip[]
  questions        Question[]
  libraryArticles  LibraryArticle[]
  testSessions     TestSession[]
  mandatoryTests   MandatoryTest[]
  trainingAssignments TrainingAssignment[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
}

model VideoClip {
  id            String     @id @default(cuid())
  title         String
  fileUrl       String     // e.g. /videos/sample-offside-1.mp4
  thumbnailUrl  String?
  duration      Int?       // seconds
  categoryId    String
  category      Category   @relation(fields: [categoryId], references: [id])
  tags          String[]
  questions     Question[]
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

model Question {
  id             String         @id @default(cuid())
  type           QuestionType
  lawNumber      Int?
  categoryId     String
  category       Category       @relation(fields: [categoryId], references: [id])
  videoClipId    String?
  videoClip      VideoClip?     @relation(fields: [videoClipId], references: [id])
  text           String
  explanation    String
  difficulty     Int            @default(1) // 1-3
  isActive       Boolean        @default(true)
  answerOptions  AnswerOption[]
  testAnswers    TestAnswer[]
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

model AnswerOption {
  id           String       @id @default(cuid())
  questionId   String
  question     Question     @relation(fields: [questionId], references: [id], onDelete: Cascade)
  label        String
  code         String       // e.g. NO_FOUL, CARELESS_FOUL
  isCorrect    Boolean
  order        Int          @default(0)
  testAnswers  TestAnswer[]
}

model TestSession {
  id               String         @id @default(cuid())
  userId           String
  user             User           @relation(fields: [userId], references: [id])
  categoryId       String
  category         Category       @relation(fields: [categoryId], references: [id])
  type             QuestionType
  mandatoryTestId  String?
  mandatoryTest    MandatoryTest? @relation(fields: [mandatoryTestId], references: [id])
  questionIds      String[]
  score            Int?
  totalQuestions   Int            @default(10)
  completedAt      DateTime?
  testAnswers      TestAnswer[]
  completion       UserTestCompletion?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
}

model TestAnswer {
  id               String       @id @default(cuid())
  testSessionId    String
  testSession      TestSession  @relation(fields: [testSessionId], references: [id], onDelete: Cascade)
  questionId       String
  question         Question     @relation(fields: [questionId], references: [id])
  selectedOptionId String?
  selectedOption   AnswerOption? @relation(fields: [selectedOptionId], references: [id])
  isCorrect        Boolean
  createdAt        DateTime     @default(now())
}

model LibraryArticle {
  id          String     @id @default(cuid())
  categoryId  String
  category    Category   @relation(fields: [categoryId], references: [id])
  title       String
  slug        String     @unique
  content     Json
  order       Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model TrainingAssignment {
  id          String             @id @default(cuid())
  userId      String
  user        User               @relation(fields: [userId], references: [id])
  categoryId  String
  category    Category           @relation(fields: [categoryId], references: [id])
  targetScore Int                @default(70)
  status      AssignmentStatus   @default(NOT_STARTED)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
}

model MandatoryTest {
  id              String                @id @default(cuid())
  title           String
  description     String?
  categoryId      String
  category        Category              @relation(fields: [categoryId], references: [id])
  dueDate         DateTime?
  lawNumbers      Int[]
  totalQuestions  Int                   @default(10)
  passingScore    Int?
  isActive        Boolean               @default(true)  // Visibility: true=visible, false=hidden
  isMandatory     Boolean               @default(true)  // Type: true=mandatory, false=pool
  isUserGenerated Boolean               @default(false) // User-created vs admin-created
  questionIds     String[]              // For manually selected specific questions
  createdById     String
  createdBy       User                  @relation(fields: [createdById], references: [id])
  testSessions    TestSession[]
  completions     UserTestCompletion[]
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
}

model UserTestCompletion {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id])
  mandatoryTestId String
  mandatoryTest   MandatoryTest     @relation(fields: [mandatoryTestId], references: [id])
  testSessionId   String            @unique
  testSession     TestSession       @relation(fields: [testSessionId], references: [id])
  completedAt     DateTime?
  score           Int?
  passed          Boolean?
  createdAt       DateTime          @default(now())

  @@unique([userId, mandatoryTestId])
}
