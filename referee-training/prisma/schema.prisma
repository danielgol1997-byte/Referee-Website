generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model User {
  id                    String               @id @default(cuid())
  email                 String               @unique
  name                  String?
  password              String?
  role                  Role                 @default(REFEREE)
  country               String?
  level                 String?
  image                 String?
  emailVerified         DateTime?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  accounts              Account[]
  mandatoryTestsCreated MandatoryTest[]
  testSessions          TestSession[]
  trainingAssignments   TrainingAssignment[]
  testCompletions       UserTestCompletion[]
  uploadedVideos        VideoClip[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Category {
  id                  String               @id @default(cuid())
  name                String               @unique
  slug                String               @unique
  type                CategoryType
  description         String?
  order               Int                  @default(0)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  libraryArticles     LibraryArticle[]
  mandatoryTests      MandatoryTest[]
  questions           Question[]
  testSessions        TestSession[]
  trainingAssignments TrainingAssignment[]
  videoClips          VideoClip[]
}

model VideoClip {
  id                  String          @id @default(cuid())
  title               String
  fileUrl             String
  thumbnailUrl        String?
  duration            Int?
  categoryId          String
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  commonMistakes      String[]        @default([])
  correctDecision     String?
  decisionExplanation String?
  description         String?
  isActive            Boolean         @default(true)
  isEducational       Boolean         @default(false) // True = explanation only, no decision
  isFeatured          Boolean         @default(false)
  keyPoints           String[]        @default([])
  lawNumbers          Int[]           @default([])
  offsideReason       OffsideReason?  // For offside-specific clips
  order               Int             @default(0)
  playOn              Boolean         @default(false) // Display "Play On" as title in answer
  noOffence           Boolean         @default(false) // Display "No Offence" as title in answer
  restartType         RestartType?
  sanctionType        SanctionType?
  uploadedById        String?
  varNotes            String?
  varRelevant         Boolean         @default(false)
  videoCategoryId     String?
  videoType           VideoType       @default(EDUCATIONAL)
  viewCount           Int             @default(0)
  questions           Question[]
  category            Category        @relation(fields: [categoryId], references: [id])
  uploadedBy          User?           @relation(fields: [uploadedById], references: [id])
  videoCategory       VideoCategory?  @relation(fields: [videoCategoryId], references: [id])
  tags                VideoTag[]

  @@index([videoCategoryId, order])
  @@index([lawNumbers])
  @@index([isActive, isFeatured])
}

model Question {
  id            String         @id @default(cuid())
  type          QuestionType
  categoryId    String
  videoClipId   String?
  text          String
  explanation   String
  difficulty    Int            @default(1)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  isActive      Boolean        @default(true)
  lawNumbers    Int[]          @default([])
  isVar         Boolean        @default(false)
  answerOptions AnswerOption[]
  category      Category       @relation(fields: [categoryId], references: [id])
  videoClip     VideoClip?     @relation(fields: [videoClipId], references: [id])
  testAnswers   TestAnswer[]
}

model AnswerOption {
  id          String       @id @default(cuid())
  questionId  String
  label       String
  code        String
  isCorrect   Boolean
  order       Int          @default(0)
  question    Question     @relation(fields: [questionId], references: [id], onDelete: Cascade)
  testAnswers TestAnswer[]
}

model TestSession {
  id              String              @id @default(cuid())
  userId          String
  categoryId      String
  type            QuestionType
  questionIds     String[]
  score           Int?
  totalQuestions  Int                 @default(10)
  completedAt     DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  mandatoryTestId String?
  testAnswers     TestAnswer[]
  category        Category            @relation(fields: [categoryId], references: [id])
  mandatoryTest   MandatoryTest?      @relation(fields: [mandatoryTestId], references: [id])
  user            User                @relation(fields: [userId], references: [id])
  completion      UserTestCompletion?
}

model TestAnswer {
  id               String        @id @default(cuid())
  testSessionId    String
  questionId       String
  selectedOptionId String?
  isCorrect        Boolean
  createdAt        DateTime      @default(now())
  question         Question      @relation(fields: [questionId], references: [id])
  selectedOption   AnswerOption? @relation(fields: [selectedOptionId], references: [id])
  testSession      TestSession   @relation(fields: [testSessionId], references: [id], onDelete: Cascade)
}

model LibraryArticle {
  id         String   @id @default(cuid())
  categoryId String
  title      String
  slug       String   @unique
  content    Json
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  category   Category @relation(fields: [categoryId], references: [id])
}

model TrainingAssignment {
  id          String           @id @default(cuid())
  userId      String
  categoryId  String
  targetScore Int              @default(70)
  status      AssignmentStatus @default(NOT_STARTED)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  category    Category         @relation(fields: [categoryId], references: [id])
  user        User             @relation(fields: [userId], references: [id])
}

model MandatoryTest {
  id              String               @id @default(cuid())
  title           String
  description     String?
  categoryId      String
  dueDate         DateTime?
  lawNumbers      Int[]
  totalQuestions  Int                  @default(10)
  passingScore    Int?
  isActive        Boolean              @default(true)
  createdById     String
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  questionIds     String[]
  isMandatory     Boolean              @default(true)
  isUserGenerated Boolean              @default(false)
  includeVar      Boolean              @default(false)
  category        Category             @relation(fields: [categoryId], references: [id])
  createdBy       User                 @relation(fields: [createdById], references: [id])
  testSessions    TestSession[]
  completions     UserTestCompletion[]
}

model UserTestCompletion {
  id              String        @id @default(cuid())
  userId          String
  mandatoryTestId String
  testSessionId   String        @unique
  completedAt     DateTime?
  score           Int?
  passed          Boolean?
  createdAt       DateTime      @default(now())
  mandatoryTest   MandatoryTest @relation(fields: [mandatoryTestId], references: [id])
  testSession     TestSession   @relation(fields: [testSessionId], references: [id])
  user            User          @relation(fields: [userId], references: [id])

  @@unique([userId, mandatoryTestId])
}

model StudyProgress {
  id         String    @id @default(cuid())
  userId     String
  questionId String
  isRead     Boolean   @default(false)
  readAt     DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([userId, questionId])
  @@index([userId, isRead])
}

model VideoCategory {
  id             String            @id @default(cuid())
  name           String
  slug           String            @unique
  description    String?
  icon           String?
  parentId       String?
  order          Int               @default(0)
  color          String?
  rapCategoryCode String?          // UEFA RAP category code (A-G, L for Laws)
  isActive       Boolean           @default(true)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  parent         VideoCategory?    @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children       VideoCategory[]   @relation("CategoryHierarchy")
  videos         VideoClip[]

  @@index([parentId, order])
  @@index([isActive])
  @@index([rapCategoryCode])
}

model Tag {
  id             String         @id @default(cuid())
  name           String         @unique
  slug           String         @unique
  categoryId     String         // Reference to TagCategory
  parentCategory String?        // For CRITERIA tags: which decision type (Challenges, Handball, etc.)
  rapCategory    String?        // For CATEGORY tags: which RAP category (A=Decision Making, B=Management, C=Offside, D=Teamwork, L=Laws)
  color          String?
  description    String?
  order          Int            @default(0)
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  category       TagCategory    @relation(fields: [categoryId], references: [id])
  videos         VideoTag[]

  @@index([isActive, order])
  @@index([categoryId, parentCategory])
  @@index([rapCategory])
}

model TagCategory {
  id                 String   @id @default(cuid())
  name               String   @unique
  slug               String   @unique
  description        String?
  canBeCorrectAnswer Boolean  @default(false) // Whether tags in this category can be selected as correct answers
  order              Int      @default(0)
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  tags               Tag[]

  @@index([isActive, order])
}

model DecisionType {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "Challenges", "Handball", "Offside"
  slug        String   @unique
  color       String   // Color used for grouping in UI
  description String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive, order])
}

model VideoTag {
  id                String    @id @default(cuid())
  videoId           String
  tagId             String
  assignedAt        DateTime  @default(now())
  isCorrectDecision Boolean   @default(false) // True if this tag is part of the correct answer
  decisionOrder     Int       @default(0)     // Order for correct decision tags (0 for invisible tags)
  tag               Tag       @relation(fields: [tagId], references: [id], onDelete: Cascade)
  video             VideoClip @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([videoId, tagId])
  @@index([videoId])
  @@index([tagId])
}

enum Role {
  REFEREE
  ADMIN
  SUPER_ADMIN
}

enum CategoryType {
  LOTG
  CHALLENGE
  VAR
  AR
  LIBRARY
}

enum QuestionType {
  LOTG_TEXT
  VIDEO_CHALLENGE
  VAR_CLIP
  AR_CLIP
}

enum AssignmentStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum VideoType {
  MATCH_CLIP          // Decision-based match footage
  EDUCATIONAL         // Explanation-only, no decision required
  TRAINING            // Skills training
  EXAMPLE             // Example clips
}

enum RestartType {
  DIRECT_FREE_KICK
  INDIRECT_FREE_KICK
  PENALTY_KICK
  CORNER_KICK
  GOAL_KICK
  THROW_IN
  KICK_OFF
  DROPPED_BALL
}

enum SanctionType {
  NO_CARD             // No card / Play on
  YELLOW_CARD         // Yellow card (caution)
  SECOND_YELLOW       // Second yellow card (sending-off)
  RED_CARD_DOGSO      // Red card - Denying an Obvious Goal-Scoring Opportunity
  RED_CARD_SFP        // Red card - Serious Foul Play
  RED_CARD_VC         // Red card - Violent Conduct
  RED_CARD_OTHER      // Red card - Other sending-off offense
}

enum OffsideReason {
  INTERFERING_WITH_PLAY        // Active interference with play
  INTERFERING_WITH_OPPONENT    // Active interference with opponent
  GAINING_ADVANTAGE            // Gaining advantage from position
  NOT_OFFSIDE                  // Not in offside position / Not offside
}
